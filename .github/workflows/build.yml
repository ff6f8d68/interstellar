name: Dev Build Release

on:
  push:
    branches:
      - main  # or whichever branch you want

jobs:
  build-and-release:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up Java
      uses: actions/setup-java@v3
      with:
        distribution: temurin
        java-version: 17

    - name: Build JAR
      run: ./gradlew build -x eclipse --info

    - name: Determine devbuild version
      id: devbuild_version
      run: |
        # File to store version history
        VERSION_FILE="devbuild_version.txt"
        
        # Initialize if missing
        if [ ! -f $VERSION_FILE ]; then
          echo "0.0.0" > $VERSION_FILE
        fi

        # Read current version
        IFS='.' read -r major minor patch < $VERSION_FILE

        # Increment patch
        patch=$((patch + 1))
        if [ "$patch" -gt 10 ]; then
          patch=0
          minor=$((minor + 1))
        fi
        if [ "$minor" -gt 10 ]; then
          minor=0
          major=$((major + 1))
        fi

        VERSION="devbuild-$major.$minor.$patch"
        echo $VERSION > $VERSION_FILE
        echo "version=$VERSION" >> $GITHUB_OUTPUT
      shell: bash

    - name: Create GitHub Release
      id: create_release
      uses: actions/create-release@v1
      with:
        tag_name: ${{ steps.devbuild_version.outputs.version }}
        release_name: ${{ steps.devbuild_version.outputs.version }}
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.PAT_TOKEN }}

    - name: Upload JAR
      uses: actions/upload-release-asset@v1
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: build/libs/ar2-0.0.0.1.jar
        asset_name: ar2-${{ steps.devbuild_version.outputs.version }}.jar
        asset_content_type: application/java-archive
